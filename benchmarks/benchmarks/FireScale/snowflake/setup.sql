CREATE OR REPLACE STORAGE INTEGRATION dataapp
  TYPE = EXTERNAL_STAGE
  STORAGE_PROVIDER = 'S3'
  ENABLED = TRUE
  STORAGE_AWS_ROLE_ARN = 'arn:aws:iam::740202120544:role/snowflake_AZB39758_s3_readonly_benchmark-amplab'
  STORAGE_ALLOWED_LOCATIONS =  ('s3://benchmark-amplab/dataapp/');
  
CREATE OR REPLACE STAGE dataapp1tbrankings
  STORAGE_INTEGRATION = dataapp
  URL = 's3://benchmark-amplab/dataapp/1tb/rankings/'
  FILE_FORMAT = (TYPE = 'PARQUET' );

create or replace TABLE RANKINGS cluster by (pageurl) (
	PAGEURL VARCHAR(16777216) NOT NULL,
	PAGERANK NUMBER(38,0),
	AVGDURATION NUMBER(38,0)
);

COPY INTO RANKINGS
FROM @dataapp1tbrankings
FILE_FORMAT = (TYPE = 'PARQUET')
MATCH_BY_COLUMN_NAME = CASE_INSENSITIVE;


create or replace TABLE USERVISITS cluster by (VISITDATE, destinationurl, sourceip)(
	SOURCEIP VARCHAR(16777216) NOT NULL,
	DESTINATIONURL VARCHAR(16777216) NOT NULL,
	VISITDATE DATE NOT NULL,
	ADREVENUE FLOAT NOT NULL,
	USERAGENT VARCHAR(16777216) NOT NULL,
	COUNTRYCODE VARCHAR(16777216) NOT NULL,
	LANGUAGECODE VARCHAR(16777216) NOT NULL,
	SEARCHWORD VARCHAR(16777216) NOT NULL,
	DURATION NUMBER(38,0) NOT NULL
);

create or replace TABLE AGENTS (
	AGENTNAME VARCHAR(16777216),
	OPERATINGSYSTEM VARCHAR(16777216),
	DEVICEARCH VARCHAR(16777216),
	BROWSER VARCHAR(16777216)
);

create or replace TABLE IPADDRESSES cluster by (IP)(
	IP VARCHAR(16777216) NOT NULL,
	AUTONOMOUSSYSTEM NUMBER(38,0) NOT NULL,
	ASNAME VARCHAR(16777216)
);

create or replace TABLE SEARCHWORDS (
	WORD VARCHAR(16777216) NOT NULL,
	WORD_HASH NUMBER(38,0) NOT NULL,
	WORD_ID NUMBER(38,0) NOT NULL,
	FIRSTSEEN DATE NOT NULL,
	IS_TOPIC BOOLEAN NOT NULL
);


CREATE OR REPLACE STAGE dataapp1tbuservisits
  STORAGE_INTEGRATION = dataapp
  URL = 's3://benchmark-amplab/dataapp/1tb/uservisits/'
  FILE_FORMAT = (TYPE = 'PARQUET' );

COPY INTO USERVISITS
FROM @dataapp1tbuservisits
FILE_FORMAT = (TYPE = 'PARQUET')
MATCH_BY_COLUMN_NAME = CASE_INSENSITIVE;

CREATE OR REPLACE STAGE dataapp1tbagents
  STORAGE_INTEGRATION = dataapp
  URL = 's3://benchmark-amplab/dataapp/1tb/dimensions/agents/'
  FILE_FORMAT = (TYPE = 'PARQUET' );

CREATE OR REPLACE STAGE dataapp1tbIPADDRESSES
  STORAGE_INTEGRATION = dataapp
  URL = 's3://benchmark-amplab/dataapp/1tb/dimensions/ipaddresses/'
  FILE_FORMAT = (TYPE = 'PARQUET' );
  
CREATE OR REPLACE STAGE dataapp1tbSEARCHWORDS
  STORAGE_INTEGRATION = dataapp
  URL = 's3://benchmark-amplab/dataapp/1tb/dimensions/searchwords/'
  FILE_FORMAT = (TYPE = 'PARQUET' );  



COPY INTO AGENTS
FROM @dataapp1tbagents
FILE_FORMAT = (TYPE = 'PARQUET')
MATCH_BY_COLUMN_NAME = CASE_INSENSITIVE;

COPY INTO IPADDRESSES
FROM @dataapp1tbIPADDRESSES
FILE_FORMAT = (TYPE = 'PARQUET')
MATCH_BY_COLUMN_NAME = CASE_INSENSITIVE;

COPY INTO SEARCHWORDS
FROM @dataapp1tbSEARCHWORDS
FILE_FORMAT = (TYPE = 'PARQUET')
MATCH_BY_COLUMN_NAME = CASE_INSENSITIVE;